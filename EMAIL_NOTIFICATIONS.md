# Email Notifications Setup Guide

## Overview

SuperPanel now supports email notifications for alerts. When alert rules are triggered, the system can automatically send professional HTML emails to specified recipients.

## Configuration

### 1. SMTP Settings

Update `src/WebAPI/appsettings.json` with your SMTP server details:

```json
{
  "Smtp": {
    "Server": "smtp.gmail.com",
    "Port": 587,
    "Username": "your-email@gmail.com",
    "Password": "your-app-password",
    "EnableSsl": true,
    "FromEmail": "noreply@superpanel.com",
    "FromName": "SuperPanel Alert System"
  }
}
```

### 2. Gmail Setup (Example)

1. **Enable 2-Factor Authentication** on your Gmail account
2. **Generate an App Password**:
   - Go to Google Account settings
   - Security â†’ 2-Step Verification â†’ App passwords
   - Generate password for "SuperPanel"
3. **Use the app password** in the `Password` field (not your regular password)

### 3. Other SMTP Providers

- **Outlook/Hotmail**: `smtp-mail.outlook.com`, Port 587
- **Yahoo**: `smtp.mail.yahoo.com`, Port 587
- **SendGrid**: `smtp.sendgrid.net`, Port 587
- **Mailgun**: `smtp.mailgun.org`, Port 587

## Alert Rule Configuration

### 1. Create Alert Rules with Email Recipients

When creating alert rules in the web interface:

1. Go to **Alerts â†’ Rules** tab
2. Click **"Create Alert Rule"**
3. Fill in the basic information (name, server, metric, threshold)
4. In the **"Email Recipients"** field, enter email addresses as JSON array:

   ```json
   ["admin@yourcompany.com", "devops@yourcompany.com"]
   ```

5. Optionally configure webhook and Slack notifications
6. Save the rule

### 2. Email Recipients Format

- Must be a valid JSON array of email addresses
- Example: `["user1@example.com", "user2@example.com"]`
- Single recipient: `["admin@example.com"]`

## Email Features

### Professional HTML Template

Emails include:

- **Branded header** with SuperPanel logo/colors
- **Alert severity badges** (Info, Warning, Error, Critical)
- **Server information** and trigger time
- **Metric details** with values and thresholds
- **Responsive design** that works on mobile devices

### Email Content

```text
Subject: SuperPanel Alert: High CPU usage on WebServer-01

ðŸš¨ High CPU usage on WebServer-01

Alert Details:
CPU usage is 85.3%, threshold: 80%

Server: WebServer-01
Triggered: 2025-01-15 14:30:22 UTC
Severity: [WARNING]

Metric: CPU
Value: 85.3%

This alert was generated by SuperPanel monitoring system.
Alert ID: 123 | Server ID: 1
```

## Testing Email Notifications

### 1. Test Alert Rule

Each alert rule has a **"Test"** button that sends a sample alert email.

### 2. Manual Testing

```bash
# Trigger a test alert via API
curl -X POST "http://localhost:5000/api/alertrules/1/test" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 3. Check Logs

Monitor the application logs for email sending status:

```text
info: SuperPanel.WebAPI.Services.EmailService[0]
      Email sent successfully to 2 recipients: SuperPanel Alert: Test Alert
```

## Troubleshooting

### Common Issues

#### 1. "SMTP settings not configured"

- Check that all SMTP fields are filled in `appsettings.json`
- Ensure the password is correct (use app password for Gmail)

#### 2. "Failed to send email"

- Verify SMTP server and port are correct
- Check firewall settings
- Ensure SSL/TLS settings match your provider

#### 3. Emails going to spam

- Add `noreply@superpanel.com` to your email contacts
- Check SPF/DKIM records for your domain
- Use a reputable SMTP provider

#### 4. "Authentication failed"

- For Gmail: Use app password, not regular password
- For corporate email: Check with IT for SMTP credentials

### Debug Mode

Enable detailed logging in `appsettings.json`:

```json
{
  "Logging": {
    "LogLevel": {
      "SuperPanel.WebAPI.Services.EmailService": "Debug"
    }
  }
}
```

## Security Considerations

### 1. Credentials Security

- Never commit SMTP passwords to version control
- Use environment variables for production:

  ```bash
  export Smtp__Password="your-secure-password"
  ```

### 2. Email Encryption

- Always use SSL/TLS (EnableSsl: true)
- Use port 587 (STARTTLS) or 465 (SMTPS)

### 3. Rate Limiting

- Implement rate limiting to prevent email spam
- Consider email service providers for high-volume alerts

## Integration Examples

### Webhook + Email + Slack

Configure alert rules to send notifications via multiple channels:

```json
{
  "name": "Critical Server Alert",
  "serverId": 1,
  "metricName": "CPU",
  "condition": "gt",
  "threshold": 90,
  "severity": "Critical",
  "emailRecipients": ["admin@company.com", "oncall@company.com"],
  "webhookUrl": "https://api.pagerduty.com/webhooks",
  "slackWebhookUrl": "https://hooks.slack.com/services/..."
}
```

## Production Deployment

### Environment Variables

For production, use environment variables instead of config files:

```bash
# SMTP Configuration
Smtp__Server=smtp.company.com
Smtp__Port=587
Smtp__Username=alerts@company.com
Smtp__Password=secure-password
Smtp__FromEmail=alerts@company.com
Smtp__FromName="Company Alert System"
```

### Docker Configuration

```yaml
# docker-compose.yml
services:
  superpanel-api:
    environment:
      - Smtp__Server=${SMTP_SERVER}
      - Smtp__Username=${SMTP_USERNAME}
      - Smtp__Password=${SMTP_PASSWORD}
```

## Support

For issues with email notifications:

1. Check application logs for detailed error messages
2. Verify SMTP settings with your email provider
3. Test SMTP connection manually using tools like `telnet`
4. Ensure firewall allows outbound SMTP traffic

---

**Status**: âœ… **Email notifications fully implemented and ready for production use**
